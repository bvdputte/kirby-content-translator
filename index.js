(function(){"use strict";const p={props:{blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},methods:{load(){return this.$api.get(`${this.parent}/sections/${this.name}`)}}};function g(t=""){return t.startsWith("/")}function _(t=""){return g(t)?t:"/"+t}const m={computed:{locales(){return this.$panel.languages.map(t=>t.code)}},methods:{getNonLocalizedPath(t){const n=new URL(t).pathname.split("/").filter(Boolean);return this.locales.includes(n[0])&&n.shift(),_(n.join("/"))}}},y=5,v={methods:{async recursiveTranslateContent(t,{sourceLanguage:e,targetLanguage:n,translatableBlocks:r={}}){const i=[],h=a=>{for(const o of a)if(!(!u(o.content)||!o.id||o.isHidden===!0)&&Object.keys(r).includes(o.type))for(const s of Object.keys(o.content))b(r[o.type]).includes(s)&&o.content[s]&&i.push(async()=>{const l=await this.$api.post("__content-translator__/translate",{sourceLanguage:e,targetLanguage:n,text:o.content[s]});o.content[s]=l.result.text})};for(const a in t)if(t[a]){if(typeof t[a]=="string")i.push(async()=>{const o=await this.$api.post("__content-translator__/translate",{sourceLanguage:e,targetLanguage:n,text:t[a]});t[a]=o.result.text});else if(Array.isArray(t[a])){if(t[a].every(o=>typeof o=="string")){t[a]=await Promise.all(t[a].filter(Boolean).map(async o=>(await this.$api.post("__content-translator__/translate",{sourceLanguage:e,targetLanguage:n,text:o})).result.text));continue}if(t[a].every(o=>u(o)&&o.columns)){for(const o of t[a])for(const s of o.columns)h(s.blocks);continue}t[a].every(o=>u(o)&&o.content)&&h(t[a])}}try{await $(i)}catch(a){throw console.error(a),a}return t}}};async function $(t,e=y){for(let n=0;n<t.length;n+=e){const r=t.slice(n,n+e);await Promise.all(r.map(i=>i()))}}function b(t){return Array.isArray(t)?t:[t]}function u(t){return typeof t=="object"&&t!==null}function C(t,e,n,r,i,h,a,o){var s=typeof t=="function"?t.options:t;e&&(s.render=e,s.staticRenderFns=n,s._compiled=!0),r&&(s.functional=!0),h&&(s._scopeId="data-v-"+h);var l;if(a?(l=function(c){c=c||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!c&&typeof __VUE_SSR_CONTEXT__<"u"&&(c=__VUE_SSR_CONTEXT__),i&&i.call(this,c),c&&c._registeredComponents&&c._registeredComponents.add(a)},s._ssrRegister=l):i&&(l=o?function(){i.call(this,(s.functional?this.parent:this).$root.$options.shadowRoot)}:i),l)if(s.functional){s._injectStyles=l;var O=s.render;s.render=function(L,f){return l.call(f),O(L,f)}}else{var d=s.beforeCreate;s.beforeCreate=d?[].concat(d,l):[l]}return{exports:t,options:s}}const w={mixins:[p,m,v],data(){return{label:void 0,confirm:!0,syncableFields:[],translatableFields:[],translatableBlocks:[],config:void 0,defaultLanguage:this.$panel.languages.find(t=>t.default),defaultContent:{}}},computed:{currentContent(){return this.$store.getters["content/values"]()},syncableContent(){return Object.fromEntries(Object.entries(this.defaultContent).filter(([t])=>this.syncableFields.includes(t)))},translatableContent(){return Object.fromEntries(Object.entries(this.currentContent).filter(([t])=>this.translatableFields.includes(t)))}},async created(){const t=await this.load();this.label=this.t(t.label)||this.$t("johannschopplich.content-translator.label"),this.confirm=t.confirm??t.config.confirm??!0,this.translatableFields=t.translatableFields??t.config.translatableFields??[],this.syncableFields=t.syncableFields??t.config.syncableFields??[],this.translatableBlocks=t.translatableBlocks??t.config.translatableBlocks??[],this.config=t.config??{},this.$panel.events.on("model.update",this.updateModelDefaultContent),this.updateModelDefaultContent()},beforeDestroy(){this.$panel.events.off("model.update",this.updateModelDefaultContent)},methods:{t(t){return Array.isArray(t)?t[this.$panel.translation.code]??Object.values(t)[0]:t},syncModelContent(){for(const[t,e]of Object.entries(this.syncableContent))this.$store.dispatch("content/update",[t,e]);this.$panel.notification.success(this.$t("johannschopplich.content-translator.notification.synced"))},async translateModelContent(t){this.$panel.view.isLoading=!0;const e=JSON.parse(JSON.stringify(this.translatableContent));try{await this.recursiveTranslateContent(e,{sourceLanguage:this.defaultLanguage.code,targetLanguage:t.code,translatableBlocks:this.translatableBlocks})}catch(n){console.error(n),this.$panel.notification.error(this.$t("error"));return}for(const[n,r]of Object.entries(e))this.$store.dispatch("content/update",[n,r]);this.$panel.view.isLoading=!1,this.$panel.notification.success(this.$t("johannschopplich.content-translator.notification.translated"))},async updateModelDefaultContent(){const{content:t}=await this.$api.get(this.$panel.view.path,{language:this.defaultLanguage.code});this.defaultContent=t},openModal(t,e){if(!this.confirm){e==null||e();return}this.$panel.dialog.open({component:"k-text-dialog",props:{text:t},on:{submit:()=>{this.$panel.dialog.close(),e==null||e()}}})}}};var k=function(){var r,i,h;var e=this,n=e._self._c;return n("k-section",{directives:[{name:"show",rawName:"v-show",value:e.config,expression:"config"}],attrs:{label:e.label}},[e.$panel.multilang?!((r=e.config)!=null&&r.translateFn)&&!((h=(i=e.config)==null?void 0:i.DeepL)!=null&&h.apiKey)?n("k-box",{attrs:{theme:"none"}},[n("k-text",[e._v(" You need to set the either a custom "),n("code",[e._v("translateFn")]),e._v(" or the "),n("code",[e._v("DeepL.apiKey")]),e._v(" option for the "),n("code",[e._v("johannschopplich.content-translator")]),e._v(" namespace in your Kirby configuration. ")])],1):e.translatableFields.length?[n("k-box",{attrs:{theme:"none"}},[n("k-button-group",{attrs:{layout:"collapsed"}},[n("k-button",{directives:[{name:"show",rawName:"v-show",value:e.syncableFields.length,expression:"syncableFields.length"}],attrs:{disabled:e.$panel.language.default,size:"sm",variant:"filled"},on:{click:function(a){e.openModal(e.$t("johannschopplich.content-translator.dialog.sync",{language:e.defaultLanguage.name}),()=>e.syncModelContent())}}},[e._v(" "+e._s(e.$t("johannschopplich.content-translator.sync"))+" ")]),e._l(e.$panel.languages.filter(a=>!a.default),function(a){return n("k-button",{key:a.code,attrs:{disabled:e.$panel.language.default,icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(o){e.openModal(e.$t("johannschopplich.content-translator.dialog.translate",{language:a.name}),()=>e.translateModelContent(a))}}},[e._v(" "+e._s(e.$t("johannschopplich.content-translator.translate",{language:a.code.toUpperCase()}))+" ")])})],2)],1),n("k-box",{directives:[{name:"show",rawName:"v-show",value:e.$panel.language.default,expression:"$panel.language.default"}],staticClass:"kct-mt-1",attrs:{theme:"none",text:e.$t("johannschopplich.content-translator.help.disallowDefaultLanguage")}})]:n("k-box",{attrs:{theme:"info"}},[n("k-text",[e._v(" You have to define at least one translatable field for the "),n("code",[e._v("translatableFields")]),e._v(" blueprint or in your Kirby configuration. ")])],1):n("k-box",{attrs:{theme:"info"}},[n("k-text",[e._v(" This section requires multi-language support to be enabled. ")])],1)],2)},F=[],x=C(w,k,F,!1,null,null,null,null);const M=x.exports;window.panel.plugin("johannschopplich/content-translator",{sections:{"content-translator":M}})})();
