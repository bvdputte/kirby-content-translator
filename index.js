(function(){"use strict";const v=/\/$|\/\?|\/#/;function b(t="",e){return e?v.test(t):t.endsWith("/")}function k(t="",e){if(!e)return t.endsWith("/")?t:t+"/";if(b(t,!0))return t||"/";let n=t,i="";const a=t.indexOf("#");if(a>=0&&(n=t.slice(0,a),i=t.slice(a),!n))return i;const[o,...s]=n.split("?");return o+"/"+(s.length>0?`?${s.join("?")}`:"")+i}function $(t=""){return t.startsWith("/")}function u(t=""){return $(t)?t:"/"+t}function y(t){return t&&t!=="/"}const C=/^\.?\//;function h(t,...e){let n=t||"";for(const i of e.filter(a=>y(a)))if(n){const a=i.replace(C,"");n=k(n)+a}else n=i;return n}const d={props:{blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},methods:{load(){return this.$api.get(`${this.parent}/sections/${this.name}`)}}},p={computed:{locales(){return this.$panel.languages.map(t=>t.code)}},methods:{getNonLocalizedPath(t){const n=new URL(t).pathname.split("/").filter(Boolean);return this.locales.includes(n[0])&&n.shift(),u(n.join("/"))}}};function g(t,e,n,i,a,o,s,c){var r=typeof t=="function"?t.options:t;e&&(r.render=e,r.staticRenderFns=n,r._compiled=!0),i&&(r.functional=!0),o&&(r._scopeId="data-v-"+o);var f;if(s?(f=function(l){l=l||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!l&&typeof __VUE_SSR_CONTEXT__<"u"&&(l=__VUE_SSR_CONTEXT__),a&&a.call(this,l),l&&l._registeredComponents&&l._registeredComponents.add(s)},r._ssrRegister=f):a&&(f=c?function(){a.call(this,(r.functional?this.parent:this).$root.$options.shadowRoot)}:a),f)if(r.functional){r._injectStyles=f;var D=r.render;r.render=function(I,m){return f.call(m),D(I,m)}}else{var _=r.beforeCreate;r.beforeCreate=_?[].concat(_,f):[f]}return{exports:t,options:r}}const w={mixins:[d,p],data(){return{label:void 0,config:{},url:""}},computed:{currentContent(){return this.$store.getters["content/values"]()},path(){if(!this.url)return"";if(!this.$panel.multilang)return new URL(this.url).pathname;let t=this.getNonLocalizedPath(this.url);return this.config.defaultLanguagePrefix?t=h(this.$panel.language.code,t):this.$panel.language.default||(t=h(this.$panel.language.code,t)),u(t)}},watch:{"$panel.language.code":{async handler(){const{url:t}=await this.$api.get(this.$panel.view.path);this.url=t},immediate:!0}},async created(){const t=await this.load();this.label=this.t(t.label)||"SERP Preview",this.config=t.config},methods:{joinURL:h,t(t){return Array.isArray(t)?t[this.$panel.translation.code]??Object.values(t)[0]:t}}};var x=function(){var e=this,n=e._self._c;return n("k-section",{attrs:{label:e.label}},[n("div",{staticClass:"kcts-overflow-hidden kcts-rounded-[var(--input-rounded)] kcts-bg-[var(--input-color-back)] kcts-p-4"},[n("div",{staticClass:"kcts-mb-2 kcts-flex kcts-items-center kcts-gap-3"},[n("figure",{staticClass:"kcts-inline-flex kcts-aspect-square kcts-h-[26px] kcts-w-[26px] kcts-items-center kcts-justify-center kcts-rounded-full kcts-border kcts-border-solid kcts-border-[#ecedef] kcts-bg-[#f1f3f4]"},[n("img",{staticClass:"kcts-block kcts-h-[18px] kcts-w-[18px]",attrs:{src:e.config.faviconUrl||"/assets/favicon.svg",alt:""}})]),n("div",{staticClass:"kcts-flex kcts-flex-col"},[n("span",{staticClass:"kcts-text-sm kcts-text-[#4d5156]"},[e._v(e._s(e.config.siteTitle))]),n("span",{staticClass:"kcts-line-clamp-1 kcts-text-xs kcts-text-[#4d5156]"},[e._v(e._s(e.joinURL(e.config.siteUrl,e.path)))])])]),n("h3",{staticClass:"kcts-mb-1 kcts-line-clamp-1 kcts-text-xl kcts-text-[#1a0dab]"},[e._v(" "+e._s(e.currentContent[e.config.titleContentKey]||`${e.$panel.view.title} ${(e.config.titleSeparator||"â€“").trim()} ${e.config.siteTitle}`)+" ")]),n("p",{staticClass:"kcts-line-clamp-2 kcts-text-sm kcts-text-[#4d5156]"},[e._v(" "+e._s(e.currentContent[e.config.descriptionContentKey])+" ")])]),n("k-button-group",{directives:[{name:"show",rawName:"v-show",value:e.config.searchConsoleUrl,expression:"config.searchConsoleUrl"}],staticClass:"kcts-mt-2 kcts-w-full"},[n("k-button",{attrs:{link:e.config.searchConsoleUrl,icon:"open",target:"_blank",rel:"noopener noreferrer"}},[e._v(" Google Search Console ")])],1)],1)},L=[],S=g(w,x,L,!1,null,null,null,null);const F=S.exports,O=5,j={methods:{async recursiveTranslateContent(t,{sourceLanguage:e,targetLanguage:n,translatableBlocks:i={}}){const a=[];for(const o in t)if(t[o]){if(typeof t[o]=="string")a.push(async()=>{const s=await this.$api.post("__content-translator__/translate",{sourceLanguage:e,targetLanguage:n,text:t[o]});t[o]=s.result.text});else if(Array.isArray(t[o])){if(t[o].every(s=>typeof s=="string"))t[o]=await Promise.all(t[o].filter(Boolean).map(async s=>(await this.$api.post("__content-translator__/translate",{sourceLanguage:e,targetLanguage:n,text:s})).result.text));else for(const s of t[o])if(!(!N(s.content)||!s.id||s.isHidden===!0)&&Object.keys(i).includes(s.type))for(const c of Object.keys(s.content))M(i[s.type]).includes(c)&&s.content[c]&&a.push(async()=>{const r=await this.$api.post("__content-translator__/translate",{sourceLanguage:e,targetLanguage:n,text:s.content[c]});s.content[c]=r.result.text})}}try{await R(a)}catch(o){throw console.error(o),o}return t}}};async function R(t,e=O){for(let n=0;n<t.length;n+=e){const i=t.slice(n,n+e);await Promise.all(i.map(a=>a()))}}function M(t){return Array.isArray(t)?t:[t]}function N(t){return typeof t=="object"&&t!==null}const T={mixins:[d,p,j],data(){return{label:void 0,confirm:!0,syncableFields:[],translatableFields:[],translatableBlocks:[],config:void 0,defaultLanguage:this.$panel.languages.find(t=>t.default),defaultContent:{}}},computed:{currentContent(){return this.$store.getters["content/values"]()},syncableContent(){return Object.fromEntries(Object.entries(this.defaultContent).filter(([t])=>this.syncableFields.includes(t)))},translatableContent(){return Object.fromEntries(Object.entries(this.currentContent).filter(([t])=>this.translatableFields.includes(t)))}},async created(){const t=await this.load();this.label=this.t(t.label)||this.$t("johannschopplich.content-translator.label"),this.confirm=t.confirm??t.config.confirm??!0,this.translatableFields=t.translatableFields??t.config.translatableFields??[],this.syncableFields=t.syncableFields??t.config.syncableFields??[],this.translatableBlocks=t.translatableBlocks??t.config.translatableBlocks??[],this.config=t.config??{},this.$panel.events.on("model.update",this.updateModelDefaultContent),this.updateModelDefaultContent()},beforeDestroy(){this.$panel.events.off("model.update",this.updateModelDefaultContent)},methods:{t(t){return Array.isArray(t)?t[this.$panel.translation.code]??Object.values(t)[0]:t},syncModelContent(){for(const[t,e]of Object.entries(this.syncableContent))this.$store.dispatch("content/update",[t,e]);this.$panel.notification.success(this.$t("johannschopplich.content-translator.notification.synced"))},async translateModelContent(t){this.$panel.view.isLoading=!0;const e=JSON.parse(JSON.stringify(this.translatableContent));try{await this.recursiveTranslateContent(e,{sourceLanguage:this.defaultLanguage.code,targetLanguage:t.code,translatableBlocks:this.translatableBlocks})}catch(n){console.error(n),this.$panel.notification.error(this.$t("error"));return}for(const[n,i]of Object.entries(e))this.$store.dispatch("content/update",[n,i]);this.$panel.view.isLoading=!1,this.$panel.notification.success(this.$t("johannschopplich.content-translator.notification.translated"))},async updateModelDefaultContent(){const{content:t}=await this.$api.get(this.$panel.view.path,{language:this.defaultLanguage.code});this.defaultContent=t},openModal(t,e){if(!this.confirm){e==null||e();return}this.$panel.dialog.open({component:"k-text-dialog",props:{text:t},on:{submit:()=>{this.$panel.dialog.close(),e==null||e()}}})}}};var U=function(){var i,a,o;var e=this,n=e._self._c;return n("k-section",{directives:[{name:"show",rawName:"v-show",value:e.config,expression:"config"}],attrs:{label:e.label}},[e.$panel.multilang?!((i=e.config)!=null&&i.translateFn)&&!((o=(a=e.config)==null?void 0:a.DeepL)!=null&&o.apiKey)?n("k-box",{attrs:{theme:"none"}},[n("k-text",[e._v(" You need to set the either a custom "),n("code",[e._v("translateFn")]),e._v(" or the "),n("code",[e._v("DeepL.apiKey")]),e._v(" option for the "),n("code",[e._v("johannschopplich.content-translator")]),e._v(" namespace in your Kirby configuration. ")])],1):e._e():n("k-box",{attrs:{theme:"info"}},[n("k-text",[e._v(" This section requires multi-language support to be enabled. ")])],1),e.translatableFields.length?n("k-box",{attrs:{theme:"none"}},[n("k-button-group",{attrs:{layout:"collapsed"}},[n("k-button",{directives:[{name:"show",rawName:"v-show",value:e.syncableFields.length,expression:"syncableFields.length"}],attrs:{disabled:e.$panel.language.default,size:"sm",variant:"filled"},on:{click:function(s){e.openModal(e.$t("johannschopplich.content-translator.dialog.sync",{language:e.defaultLanguage.name}),()=>e.syncModelContent())}}},[e._v(" "+e._s(e.$t("johannschopplich.content-translator.sync"))+" ")]),e._l(e.$panel.languages.filter(s=>!s.default),function(s){return n("k-button",{key:s.code,attrs:{disabled:e.$panel.language.default,icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(c){e.openModal(e.$t("johannschopplich.content-translator.dialog.translate",{language:s.name}),()=>e.translateModelContent(s))}}},[e._v(" "+e._s(e.$t("johannschopplich.content-translator.translate",{language:s.code.toUpperCase()}))+" ")])})],2)],1):n("k-box",{attrs:{theme:"info"}},[n("k-text",[e._v(" You have to define at least one translatable field for the "),n("code",[e._v("translatableFields")]),e._v(" blueprint or in your Kirby configuration. ")])],1),n("k-box",{directives:[{name:"show",rawName:"v-show",value:e.$panel.language.default,expression:"$panel.language.default"}],staticClass:"kcts-mt-1",attrs:{theme:"none",text:e.$t("johannschopplich.content-translator.help.disallowDefaultLanguage")}})],1)},A=[],E=g(T,U,A,!1,null,null,null,null);const B=E.exports;window.panel.plugin("johannschopplich/website",{sections:{"serp-preview":F,"content-translator":B}})})();
