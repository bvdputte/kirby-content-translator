(function(){"use strict";const g={props:{blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},methods:{load(){return this.$api.get(`${this.parent}/sections/${this.name}`)}}};function y(e=""){return e.startsWith("/")}function _(e=""){return y(e)?e:"/"+e}const m={computed:{locales(){return this.$panel.languages.map(e=>e.code)}},methods:{getNonLocalizedPath(e){const a=new URL(e).pathname.split("/").filter(Boolean);return this.locales.includes(a[0])&&a.shift(),_(a.join("/"))}}},b=5,v={methods:{async recursiveTranslateContent(e,{sourceLanguage:t,targetLanguage:a,translatableStructureFields:r=[],translatableBlocks:i={}}){const u=[],h=o=>{for(const n of o)for(const s in n)r.includes(s)&&n[s]&&(typeof n[s]=="string"?u.push(async()=>{const l=await window.panel.api.post("__content-translator__/translate",{sourceLanguage:t,targetLanguage:a,text:n[s]});n[s]=l.result.text}):Array.isArray(n[s])&&n[s].every(l=>typeof l=="string")&&u.push(async()=>{for(const l in n[s]){if(!n[s][l])continue;const c=await window.panel.api.post("__content-translator__/translate",{sourceLanguage:t,targetLanguage:a,text:n[s][l]});n[s][l]=c.result.text}}))},p=o=>{for(const n of o)if(!(!d(n.content)||!n.id||n.isHidden===!0)&&Object.keys(i).includes(n.type)){for(const s of Object.keys(n.content))if(w(i[n.type]).includes(s)&&n.content[s]){if(Array.isArray(n.content[s])&&n.content[s].every(l=>d(l)&&l.content)){p(n.content[s]);continue}if(Array.isArray(n.content[s])&&n.content[s].every(l=>d(l)&&Object.keys(l).some(c=>r.includes(c)))){h(n.content[s]);continue}u.push(async()=>{const l=await window.panel.api.post("__content-translator__/translate",{sourceLanguage:t,targetLanguage:a,text:n.content[s]});n.content[s]=l.result.text})}}};for(const o in e)if(e[o]){if(typeof e[o]=="string")u.push(async()=>{const n=await window.panel.api.post("__content-translator__/translate",{sourceLanguage:t,targetLanguage:a,text:e[o]});e[o]=n.result.text});else if(Array.isArray(e[o])&&e[o].length>0){if(e[o].every(n=>typeof n=="string")){e[o]=await Promise.all(e[o].filter(Boolean).map(async n=>(await window.panel.api.post("__content-translator__/translate",{sourceLanguage:t,targetLanguage:a,text:n})).result.text));continue}if(e[o].every(n=>d(n)&&n.columns)){for(const n of e[o])for(const s of n.columns)p(s.blocks);continue}if(e[o].every(n=>d(n)&&n.content)&&p(e[o]),e[o].every(n=>d(n)&&Object.keys(n).some(s=>r.includes(s)))){h(e[o]);continue}}}try{await $(u)}catch(o){throw console.error(o),o}return e}}};async function $(e,t=b){for(let a=0;a<e.length;a+=t){const r=e.slice(a,a+t);await Promise.all(r.map(i=>i()))}}function w(e){return Array.isArray(e)?e:[e]}function d(e){return typeof e=="object"&&e!==null}function C(e,t,a,r,i,u,h,p){var o=typeof e=="function"?e.options:e;t&&(o.render=t,o.staticRenderFns=a,o._compiled=!0),r&&(o.functional=!0),u&&(o._scopeId="data-v-"+u);var n;if(h?(n=function(c){c=c||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!c&&typeof __VUE_SSR_CONTEXT__<"u"&&(c=__VUE_SSR_CONTEXT__),i&&i.call(this,c),c&&c._registeredComponents&&c._registeredComponents.add(h)},o._ssrRegister=n):i&&(n=p?function(){i.call(this,(o.functional?this.parent:this).$root.$options.shadowRoot)}:i),n)if(o.functional){o._injectStyles=n;var s=o.render;o.render=function(S,f){return n.call(f),s(S,f)}}else{var l=o.beforeCreate;o.beforeCreate=l?[].concat(l,n):[n]}return{exports:e,options:o}}const k={mixins:[g,m,v],inheritAttrs:!1,data(){return{label:void 0,confirm:!0,syncableFields:[],translatableFields:[],translatableStructureFields:[],translatableBlocks:[],config:void 0,defaultLanguage:this.$panel.languages.find(e=>e.default),defaultTitle:void 0,defaultContent:{}}},computed:{currentContent(){return this.$store.getters["content/values"]()},syncableContent(){return Object.fromEntries(Object.entries(this.defaultContent).filter(([e])=>this.syncableFields.includes(e)))},translatableContent(){return Object.fromEntries(Object.entries(this.currentContent).filter(([e])=>this.translatableFields.includes(e)))}},async created(){const e=await this.load();this.label=this.t(e.label)||this.$t("johannschopplich.content-translator.label"),this.confirm=e.confirm??e.config.confirm??!0,this.translatableFields=e.translatableFields??e.config.translatableFields??[],this.translatableStructureFields=e.translatableStructureFields??e.config.translatableStructureFields??[],this.syncableFields=e.syncableFields??e.config.syncableFields??[],this.translatableBlocks=e.translatableBlocks??e.config.translatableBlocks??[],this.config=e.config??{},this.$panel.events.on("model.update",this.updateModelDefaultContent),this.updateModelDefaultContent()},beforeDestroy(){this.$panel.events.off("model.update",this.updateModelDefaultContent)},methods:{t(e){return!e||typeof e=="string"?e:e[this.$panel.translation.code]??Object.values(e)[0]},async syncModelContent(e){const t=e?await this.getSyncableContentForLanguage(e):this.syncableContent;for(const[a,r]of Object.entries(t))this.$store.dispatch("content/update",[a,r]);this.$panel.notification.success(this.$t("johannschopplich.content-translator.notification.synced"))},async translateModelContent(e,t){this.$panel.view.isLoading=!0;const a=JSON.parse(JSON.stringify(this.translatableContent));try{await this.recursiveTranslateContent(a,{sourceLanguage:t==null?void 0:t.code,targetLanguage:e.code,translatableStructureFields:this.translatableStructureFields,translatableBlocks:this.translatableBlocks})}catch(r){console.error(r),this.$panel.notification.error(this.$t("error"));return}for(const[r,i]of Object.entries(a))this.$store.dispatch("content/update",[r,i]);this.$panel.view.isLoading=!1,this.$panel.notification.success(this.$t("johannschopplich.content-translator.notification.translated"))},async updateModelDefaultContent(){const{title:e,content:t}=await this.$api.get(this.$panel.view.path,{language:this.defaultLanguage.code});this.defaultTitle=e,this.defaultContent=t},async getSyncableContentForLanguage(e){const{content:t}=await this.$api.get(this.$panel.view.path,{language:e.code});return Object.fromEntries(Object.entries(t).filter(([a])=>this.syncableFields.includes(a)))},openModal(e,t){if(!this.confirm){t==null||t();return}this.$panel.dialog.open({component:"k-text-dialog",props:{text:e},on:{submit:()=>{this.$panel.dialog.close(),t==null||t()}}})}}};var F=function(){var r;var t=this,a=t._self._c;return t.config?a("k-section",{attrs:{label:t.label}},[t.$panel.multilang?!t.config.translateFn&&!((r=t.config.DeepL)!=null&&r.apiKey)?a("k-box",{attrs:{theme:"empty"}},[a("k-text",[t._v(" You need to set the either a custom "),a("code",[t._v("translateFn")]),t._v(" or the "),a("code",[t._v("DeepL.apiKey")]),t._v(" option for the "),a("code",[t._v("johannschopplich.content-translator")]),t._v(" namespace in your Kirby configuration. ")])],1):t.translatableFields.length?t.config.allowDefaultLanguageOverwrite?a("k-box",{attrs:{theme:"none"}},[a("k-button-group",{attrs:{layout:"collapsed"}},[t._l(t.$panel.languages.filter(i=>i.code!==t.$panel.language.code),function(i){return a("k-button",{directives:[{name:"show",rawName:"v-show",value:t.syncableFields.length,expression:"syncableFields.length"}],key:i.code,attrs:{size:"sm",variant:"filled"},on:{click:function(u){t.openModal(t.$t("johannschopplich.content-translator.dialog.syncFrom",{language:i.name}),()=>t.syncModelContent(i))}}},[t._v(" "+t._s(t.$t("johannschopplich.content-translator.importFrom",{language:i.code.toUpperCase()}))+" ")])}),a("k-button",{attrs:{icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(i){t.openModal(t.$t("johannschopplich.content-translator.dialog.translate",{language:t.$panel.language.name}),()=>t.translateModelContent(t.$panel.language))}}},[t._v(" "+t._s(t.$t("johannschopplich.content-translator.translate",{language:t.$panel.language.code.toUpperCase()}))+" ")])],2)],1):[a("k-box",{attrs:{theme:"none"}},[a("k-button-group",{attrs:{layout:"collapsed"}},[a("k-button",{directives:[{name:"show",rawName:"v-show",value:t.syncableFields.length,expression:"syncableFields.length"}],attrs:{disabled:t.$panel.language.default,size:"sm",variant:"filled"},on:{click:function(i){t.openModal(t.$t("johannschopplich.content-translator.dialog.sync",{language:t.defaultLanguage.name}),()=>t.syncModelContent())}}},[t._v(" "+t._s(t.$t("johannschopplich.content-translator.sync"))+" ")]),a("k-button",{attrs:{disabled:t.$panel.language.default,icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(i){t.openModal(t.$t("johannschopplich.content-translator.dialog.translate",{language:t.$panel.language.name}),()=>t.translateModelContent(t.$panel.language,t.defaultLanguage))}}},[t._v(" "+t._s(t.$t("johannschopplich.content-translator.translate",{language:t.$panel.language.code.toUpperCase()}))+" ")])],1)],1),a("k-box",{directives:[{name:"show",rawName:"v-show",value:t.$panel.language.default,expression:"$panel.language.default"}],staticClass:"kct-mt-1",attrs:{theme:"none",text:t.$t("johannschopplich.content-translator.help.disallowDefaultLanguage")}})]:a("k-box",{attrs:{theme:"info"}},[a("k-text",[t._v(" You have to define at least one translatable field for the "),a("code",[t._v("translatableFields")]),t._v(" blueprint or in your Kirby configuration. ")])],1):a("k-box",{attrs:{theme:"info"}},[a("k-text",[t._v(" This section requires multi-language support to be enabled. ")])],1)],2):t._e()},x=[],O=C(k,F,x,!1,null,null,null,null);const M=O.exports;window.panel.plugin("johannschopplich/content-translator",{sections:{"content-translator":M}})})();
