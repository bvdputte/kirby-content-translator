(function(){"use strict";const o=window.Vue;function R(){return window.panel}function E(){return R().api}function P(){const s=E();return{load:({parent:e,name:t})=>s.get(`${e}/sections/${t}`)}}function U(){var a;return((a=o.getCurrentInstance())==null?void 0:a.proxy).$store}const j=o.computed;o.customRef,o.defineAsyncComponent,o.defineComponent,o.effectScope,o.getCurrentInstance,o.getCurrentScope,o.h,o.inject,o.isProxy,o.isReactive,o.isReadonly,o.isRef,o.isShallow,o.markRaw,o.nextTick,o.onActivated,o.onBeforeMount;const z=o.onBeforeUnmount;o.onBeforeUpdate,o.onDeactivated,o.onErrorCaptured,o.onMounted,o.onRenderTracked,o.onRenderTriggered,o.onScopeDispose,o.onServerPrefetch,o.onUnmounted,o.onUpdated,o.provide,o.proxyRefs,o.reactive,o.readonly;const w=o.ref;o.shallowReactive,o.shallowReadonly,o.shallowRef,o.toRaw,o.toRef,o.toRefs,o.triggerRef,o.unref,o.useAttrs,o.useCssModule,o.useCssVars,o.useListeners,o.useSlots,o.watch,o.watchEffect,o.watchPostEffect,o.watchSyncEffect;const K={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},I="__content-translator__/translate";class V extends Error{constructor(a){super(),this.name="AbortError",this.message=a}}const D=s=>globalThis.DOMException===void 0?new V(s):new DOMException(s),N=s=>{const a=s.reason===void 0?D("This operation was aborted."):s.reason;return a instanceof Error?a:D(a)};async function Y(s,a,{concurrency:e=Number.POSITIVE_INFINITY,stopOnError:t=!0,signal:p}={}){return new Promise((f,m)=>{if(s[Symbol.iterator]===void 0&&s[Symbol.asyncIterator]===void 0)throw new TypeError(`Expected \`input\` to be either an \`Iterable\` or \`AsyncIterable\`, got (${typeof s})`);if(typeof a!="function")throw new TypeError("Mapper function is required");if(!((Number.isSafeInteger(e)||e===Number.POSITIVE_INFINITY)&&e>=1))throw new TypeError(`Expected \`concurrency\` to be an integer from 1 and up or \`Infinity\`, got \`${e}\` (${typeof e})`);const h=[],d=[],v=new Map;let c=!1,n=!1,r=!1,l=0,b=0;const M=s[Symbol.iterator]===void 0?s[Symbol.asyncIterator]():s[Symbol.iterator](),_=x=>{c=!0,n=!0,m(x)};p&&(p.aborted&&_(N(p)),p.addEventListener("abort",()=>{_(N(p))}));const A=async()=>{if(n)return;const x=await M.next(),S=b;if(b++,x.done){if(r=!0,l===0&&!n){if(!t&&d.length>0){_(new AggregateError(d));return}if(n=!0,v.size===0){f(h);return}const y=[];for(const[g,O]of h.entries())v.get(g)!==$&&y.push(O);f(y)}return}l++,(async()=>{try{const y=await x.value;if(n)return;const g=await a(y,S);g===$&&v.set(S,g),h[S]=g,l--,await A()}catch(y){if(t)_(y);else{d.push(y),l--;try{await A()}catch(g){_(g)}}}})()};(async()=>{for(let x=0;x<e;x++){try{await A()}catch(S){_(S);break}if(r||c)break}})()})}const $=Symbol("skip");async function q(s,a){return Y(s,e=>e(),a)}function J(){const s=E();return{recursiveTranslateContent:async(e,{sourceLanguage:t,targetLanguage:p,translatableStructureFields:f=[],translatableBlocks:m={}})=>{const h=[],d=c=>{for(const n of c)for(const r in n)f.includes(r)&&n[r]&&(typeof n[r]=="string"?h.push(async()=>{const l=await s.post(I,{sourceLanguage:t,targetLanguage:p,text:n[r]});n[r]=l.text}):Array.isArray(n[r])&&n[r].every(l=>typeof l=="string")&&h.push(async()=>{for(const l in n[r]){if(!n[r][l])continue;const b=await s.post(I,{sourceLanguage:t,targetLanguage:p,text:n[r][l]});n[r][l]=b.text}}))},v=c=>{for(const n of c)if(!(!T(n.content)||!n.id||n.isHidden===!0)&&Object.keys(m).includes(n.type)){for(const r of Object.keys(n.content))if(H(m[n.type]).includes(r)&&n.content[r]){if(Array.isArray(n.content[r])&&n.content[r].every(l=>T(l)&&l.content)){v(n.content[r]);continue}if(Array.isArray(n.content[r])&&n.content[r].every(l=>T(l)&&Object.keys(l).some(b=>f.includes(b)))){d(n.content[r]);continue}h.push(async()=>{const l=await s.post(I,{sourceLanguage:t,targetLanguage:p,text:n.content[r]});n.content[r]=l.text})}}};for(const c in e)if(e[c]){if(typeof e[c]=="string")h.push(async()=>{const n=await s.post(I,{sourceLanguage:t,targetLanguage:p,text:e[c]});e[c]=n.text});else if(Array.isArray(e[c])&&e[c].length>0){if(e[c].every(n=>typeof n=="string")){e[c]=await Promise.all(e[c].filter(Boolean).map(async n=>(await s.post(I,{sourceLanguage:t,targetLanguage:p,text:n})).text));continue}if(e[c].every(n=>T(n)&&n.columns)){for(const n of e[c])for(const r of n.columns)v(r.blocks);continue}if(e[c].every(n=>T(n)&&n.content)&&v(e[c]),e[c].every(n=>T(n)&&Object.keys(n).some(r=>f.includes(r)))){d(e[c]);continue}}}try{await q(h,{concurrency:5})}catch(c){throw console.error(c),c}return e}}}function H(s){return s=s??[],Array.isArray(s)?s:[s]}function T(s){return typeof s=="object"&&s!==null}function G(s,a,e,t,p,f,m,h){var d=typeof s=="function"?s.options:s;return a&&(d.render=a,d.staticRenderFns=e,d._compiled=!0),{exports:s,options:d}}const B={...K},L=Object.assign({inheritAttrs:!1},{__name:"ContentTranslator",props:B,setup(s){const a=s,e=R(),t=U(),{recursiveTranslateContent:p}=J(),f=w(),m=w(!0),h=w([]),d=w([]),v=w([]),c=w([]),n=w(!1),r=w(),l=w({}),b=e.languages.find(u=>u.default),M=j(()=>t.getters["content/values"]()),_=j(()=>Object.fromEntries(Object.entries(M.value).filter(([u])=>d.value.includes(u))));(async()=>{const{load:u}=P(),i=await u({parent:a.parent,name:a.name});f.value=A(i.label)||e.t("johannschopplich.content-translator.label"),m.value=i.confirm??i.config.confirm??!0,d.value=i.translatableFields??i.config.translatableFields??[],v.value=i.translatableStructureFields??i.config.translatableStructureFields??[],h.value=i.syncableFields??i.config.syncableFields??[],c.value=i.translatableBlocks??i.config.translatableBlocks??[],n.value=i.title??i.config.title??!1,r.value=i.config??{},e.events.on("model.update",y),e.events.on("page.changeTitle",y),y()})(),z(()=>{e.events.off("model.update",y),e.events.off("page.changeTitle",y)});function A(u){return!u||typeof u=="string"?u:u[e.translation.code]??Object.values(u)[0]}async function x(u){let{title:i,content:F}=l.value;if(u){const k=await g(u);i=k.title,F=k.content}const C=Object.fromEntries(Object.entries(F).filter(([k])=>h.value.includes(k)));for(const[k,ee]of Object.entries(C))t.dispatch("content/update",[k,ee]);n.value&&(await e.api.patch(`${e.view.path}/title`,{title:i}),await e.view.reload()),e.notification.success(e.t("johannschopplich.content-translator.notification.synced"))}async function S(u,i){e.view.isLoading=!0;const F=JSON.parse(JSON.stringify(_.value));try{await p(F,{sourceLanguage:i==null?void 0:i.code,targetLanguage:u.code,translatableStructureFields:v.value,translatableBlocks:c.value})}catch(C){console.error(C),e.notification.error(e.t("error"));return}for(const[C,k]of Object.entries(F))t.dispatch("content/update",[C,k]);if(n.value){const{text:C}=await e.api.post(I,{sourceLanguage:i==null?void 0:i.code,targetLanguage:u.code,text:e.view.title});await e.api.patch(`${e.view.path}/title`,{title:C}),await e.view.reload()}else e.view.isLoading=!1;e.notification.success(e.t("johannschopplich.content-translator.notification.translated"))}async function y(){l.value=await g(b)}function g(u){return e.api.get(e.view.path,{language:u.code})}function O(u,i){if(!m.value){i==null||i();return}e.dialog.open({component:"k-text-dialog",props:{text:u},on:{submit:()=>{e.dialog.close(),i==null||i()}}})}return{__sfc:!0,propsDefinition:B,props:a,panel:e,store:t,recursiveTranslateContent:p,label:f,confirm:m,syncableFields:h,translatableFields:d,translatableStructureFields:v,translatableBlocks:c,translateTitle:n,config:r,defaultLanguageData:l,defaultLanguage:b,currentContent:M,translatableContent:_,t:A,syncModelContent:x,translateModelContent:S,updateModelDefaultLanguageData:y,getModelData:g,openModal:O}}});var Q=function(){var p;var a=this,e=a._self._c,t=a._self._setupProxy;return t.config?e("k-section",{attrs:{label:t.label}},[t.panel.multilang?!t.config.translateFn&&!((p=t.config.DeepL)!=null&&p.apiKey)?e("k-box",{attrs:{theme:"empty"}},[e("k-text",[a._v(" You need to set the either a custom "),e("code",[a._v("translateFn")]),a._v(" or the "),e("code",[a._v("DeepL.apiKey")]),a._v(" option for the "),e("code",[a._v("johannschopplich.content-translator")]),a._v(" namespace in your Kirby configuration. ")])],1):t.translatableFields.length?t.config.allowDefaultLanguageOverwrite?e("k-box",{attrs:{theme:"none"}},[e("k-button-group",{attrs:{layout:"collapsed"}},[a._l(t.panel.languages.filter(f=>f.code!==t.panel.language.code),function(f){return e("k-button",{directives:[{name:"show",rawName:"v-show",value:t.syncableFields.length,expression:"syncableFields.length"}],key:f.code,attrs:{size:"sm",variant:"filled"},on:{click:function(m){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.syncFrom",{language:f.name}),()=>t.syncModelContent(f))}}},[a._v(" "+a._s(t.panel.t("johannschopplich.content-translator.importFrom",{language:f.code.toUpperCase()}))+" ")])}),e("k-button",{attrs:{icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(f){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.translate",{language:t.panel.language.name}),()=>t.translateModelContent(t.panel.language))}}},[a._v(" "+a._s(t.panel.t("johannschopplich.content-translator.translate",{language:t.panel.language.code.toUpperCase()}))+" ")])],2)],1):[e("k-box",{attrs:{theme:"none"}},[e("k-button-group",{attrs:{layout:"collapsed"}},[e("k-button",{directives:[{name:"show",rawName:"v-show",value:t.syncableFields.length,expression:"syncableFields.length"}],attrs:{disabled:t.panel.language.default,size:"sm",variant:"filled"},on:{click:function(f){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.sync",{language:t.defaultLanguage.name}),()=>t.syncModelContent())}}},[a._v(" "+a._s(t.panel.t("johannschopplich.content-translator.sync"))+" ")]),e("k-button",{attrs:{disabled:t.panel.language.default,icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(f){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.translate",{language:t.panel.language.name}),()=>t.translateModelContent(t.panel.language,t.defaultLanguage))}}},[a._v(" "+a._s(t.panel.t("johannschopplich.content-translator.translate",{language:t.panel.language.code.toUpperCase()}))+" ")])],1)],1),e("k-box",{directives:[{name:"show",rawName:"v-show",value:t.panel.language.default,expression:"panel.language.default"}],staticClass:"kct-mt-1",attrs:{theme:"none",text:t.panel.t("johannschopplich.content-translator.help.disallowDefaultLanguage")}})]:e("k-box",{attrs:{theme:"info"}},[e("k-text",[a._v(" You have to define at least one translatable field for the "),e("code",[a._v("translatableFields")]),a._v(" blueprint or in your Kirby configuration. ")])],1):e("k-box",{attrs:{theme:"info"}},[e("k-text",[a._v(" This section requires multi-language support to be enabled. ")])],1)],2):a._e()},W=[],X=G(L,Q,W);const Z=X.exports;window.panel.plugin("johannschopplich/content-translator",{sections:{"content-translator":Z}})})();
