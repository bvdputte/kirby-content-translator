(function(){"use strict";const n=window.Vue;function R(){return window.panel}function S(){return R().api}function $(){const l=S();return{load:({parent:e,name:t})=>l.get(`${e}/sections/${t}`)}}function B(){var s;return((s=n.getCurrentInstance())==null?void 0:s.proxy).$store}const F=n.computed;n.customRef,n.defineAsyncComponent;const E=n.defineComponent;n.effectScope,n.getCurrentInstance,n.getCurrentScope,n.h,n.inject,n.isProxy,n.isReactive,n.isReadonly,n.isRef,n.isShallow,n.markRaw,n.nextTick,n.onActivated,n.onBeforeMount;const N=n.onBeforeUnmount;n.onBeforeUpdate,n.onDeactivated,n.onErrorCaptured,n.onMounted,n.onRenderTracked,n.onRenderTriggered,n.onScopeDispose,n.onServerPrefetch,n.onUnmounted,n.onUpdated,n.provide,n.proxyRefs,n.reactive,n.readonly;const y=n.ref;n.shallowReactive,n.shallowReadonly,n.shallowRef,n.toRaw,n.toRef,n.toRefs,n.triggerRef,n.unref,n.useAttrs,n.useCssModule,n.useCssVars,n.useListeners,n.useSlots,n.watch,n.watchEffect,n.watchPostEffect,n.watchSyncEffect;const D={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},w="__content-translator__/translate",I=5;function P(){const l=S();return{recursiveTranslateContent:async(e,{sourceLanguage:t,targetLanguage:p,translatableStructureFields:d=[],translatableBlocks:g={}})=>{const v=[],u=i=>{for(const o of i)for(const a in o)d.includes(a)&&o[a]&&(typeof o[a]=="string"?v.push(async()=>{const f=await l.post(w,{sourceLanguage:t,targetLanguage:p,text:o[a]});o[a]=f.result.text}):Array.isArray(o[a])&&o[a].every(f=>typeof f=="string")&&v.push(async()=>{for(const f in o[a]){if(!o[a][f])continue;const m=await l.post(w,{sourceLanguage:t,targetLanguage:p,text:o[a][f]});o[a][f]=m.result.text}}))},h=i=>{for(const o of i)if(!(!b(o.content)||!o.id||o.isHidden===!0)&&Object.keys(g).includes(o.type)){for(const a of Object.keys(o.content))if(z(g[o.type]).includes(a)&&o.content[a]){if(Array.isArray(o.content[a])&&o.content[a].every(f=>b(f)&&f.content)){h(o.content[a]);continue}if(Array.isArray(o.content[a])&&o.content[a].every(f=>b(f)&&Object.keys(f).some(m=>d.includes(m)))){u(o.content[a]);continue}v.push(async()=>{const f=await l.post(w,{sourceLanguage:t,targetLanguage:p,text:o.content[a]});o.content[a]=f.result.text})}}};for(const i in e)if(e[i]){if(typeof e[i]=="string")v.push(async()=>{const o=await l.post(w,{sourceLanguage:t,targetLanguage:p,text:e[i]});e[i]=o.result.text});else if(Array.isArray(e[i])&&e[i].length>0){if(e[i].every(o=>typeof o=="string")){e[i]=await Promise.all(e[i].filter(Boolean).map(async o=>(await l.post(w,{sourceLanguage:t,targetLanguage:p,text:o})).result.text));continue}if(e[i].every(o=>b(o)&&o.columns)){for(const o of e[i])for(const a of o.columns)h(a.blocks);continue}if(e[i].every(o=>b(o)&&o.content)&&h(e[i]),e[i].every(o=>b(o)&&Object.keys(o).some(a=>d.includes(a)))){u(e[i]);continue}}}try{await V(v)}catch(i){throw console.error(i),i}return e}}}async function V(l,s=I){for(let e=0;e<l.length;e+=s){const t=l.slice(e,e+s);await Promise.all(t.map(p=>p()))}}function z(l){return Array.isArray(l)?l:[l]}function b(l){return typeof l=="object"&&l!==null}function K(l,s,e,t,p,d,g,v){var u=typeof l=="function"?l.options:l;s&&(u.render=s,u.staticRenderFns=e,u._compiled=!0),t&&(u.functional=!0),d&&(u._scopeId="data-v-"+d);var h;if(g?(h=function(a){a=a||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!a&&typeof __VUE_SSR_CONTEXT__<"u"&&(a=__VUE_SSR_CONTEXT__),p&&p.call(this,a),a&&a._registeredComponents&&a._registeredComponents.add(g)},u._ssrRegister=h):p&&(h=v?function(){p.call(this,(u.functional?this.parent:this).$root.$options.shadowRoot)}:p),h)if(u.functional){u._injectStyles=h;var i=u.render;u.render=function(f,m){return h.call(m),i(f,m)}}else{var o=u.beforeCreate;u.beforeCreate=o?[].concat(o,h):[h]}return{exports:l,options:u}}const J=E({inheritAttrs:!1,props:{...D}}),X=Object.assign(J,{__name:"ContentTranslator",props:{},setup(l){const s=l,e=R(),t=B(),{recursiveTranslateContent:p}=P(),d=y(),g=y(!0),v=y([]),u=y([]),h=y([]),i=y([]),o=y(!1),a=y(),f=y(),m=y({}),T=e.languages.find(c=>c.default),A=F(()=>t.getters["content/values"]()),M=F(()=>Object.fromEntries(Object.entries(m.value).filter(([c])=>v.value.includes(c)))),j=F(()=>Object.fromEntries(Object.entries(A.value).filter(([c])=>u.value.includes(c))));(async()=>{const{load:c}=$(),r=await c({parent:s.parent,name:s.name});d.value=U(r.label)||e.t("johannschopplich.content-translator.label"),g.value=r.confirm??r.config.confirm??!0,u.value=r.translatableFields??r.config.translatableFields??[],h.value=r.translatableStructureFields??r.config.translatableStructureFields??[],v.value=r.syncableFields??r.config.syncableFields??[],i.value=r.translatableBlocks??r.config.translatableBlocks??[],o.value=r.title??r.config.title??!1,a.value=r.config??{},e.events.on("model.update",x),x()})(),N(()=>{e.events.off("model.update",x)});function U(c){return!c||typeof c=="string"?c:c[e.translation.code]??Object.values(c)[0]}async function W(c){let r=f.value,C=M.value;if(c){const{title:_,content:k}=await O(c);r=_,C=Object.fromEntries(Object.entries(k).filter(([L])=>v.value.includes(L)))}for(const[_,k]of Object.entries(C))t.dispatch("content/update",[_,k]);o.value&&(await e.api.patch(e.view.path,{title:r}),e.view.refresh()),e.notification.success(e.t("johannschopplich.content-translator.notification.synced"))}async function G(c,r){e.view.isLoading=!0;const C=JSON.parse(JSON.stringify(j.value));try{await p(C,{sourceLanguage:r==null?void 0:r.code,targetLanguage:c.code,translatableStructureFields:h.value,translatableBlocks:i.value})}catch(_){console.error(_),e.notification.error(e.t("error"));return}for(const[_,k]of Object.entries(C))t.dispatch("content/update",[_,k]);if(o.value){const _=await e.api.post(w,{sourceLanguage:r==null?void 0:r.code,targetLanguage:c.code,text:e.view.title});await e.api.patch(e.view.path,{title:_.result.text}),e.view.refresh()}e.view.isLoading=!1,e.notification.success(e.t("johannschopplich.content-translator.notification.translated"))}async function x(){const{title:c,content:r}=await O(T);f.value=c,m.value=r}function O(c){return e.api.get(e.view.path,{language:c.code})}function Z(c,r){if(!g.value){r==null||r();return}e.dialog.open({component:"k-text-dialog",props:{text:c},on:{submit:()=>{e.dialog.close(),r==null||r()}}})}return{__sfc:!0,props:s,panel:e,store:t,recursiveTranslateContent:p,label:d,confirm:g,syncableFields:v,translatableFields:u,translatableStructureFields:h,translatableBlocks:i,translateTitle:o,config:a,defaultTitle:f,defaultContent:m,defaultLanguage:T,currentContent:A,syncableContent:M,translatableContent:j,t:U,syncModelContent:W,translateModelContent:G,updateModelDefaultContent:x,getCurrentViewData:O,openModal:Z}}});var Y=function(){var p;var s=this,e=s._self._c,t=s._self._setupProxy;return t.config?e("k-section",{attrs:{label:t.label}},[t.panel.multilang?!t.config.translateFn&&!((p=t.config.DeepL)!=null&&p.apiKey)?e("k-box",{attrs:{theme:"empty"}},[e("k-text",[s._v(" You need to set the either a custom "),e("code",[s._v("translateFn")]),s._v(" or the "),e("code",[s._v("DeepL.apiKey")]),s._v(" option for the "),e("code",[s._v("johannschopplich.content-translator")]),s._v(" namespace in your Kirby configuration. ")])],1):t.translatableFields.length?t.config.allowDefaultLanguageOverwrite?e("k-box",{attrs:{theme:"none"}},[e("k-button-group",{attrs:{layout:"collapsed"}},[s._l(t.panel.languages.filter(d=>d.code!==t.panel.language.code),function(d){return e("k-button",{directives:[{name:"show",rawName:"v-show",value:t.syncableFields.length,expression:"syncableFields.length"}],key:d.code,attrs:{size:"sm",variant:"filled"},on:{click:function(g){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.syncFrom",{language:d.name}),()=>t.syncModelContent(d))}}},[s._v(" "+s._s(t.panel.t("johannschopplich.content-translator.importFrom",{language:d.code.toUpperCase()}))+" ")])}),e("k-button",{attrs:{icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(d){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.translate",{language:t.panel.language.name}),()=>t.translateModelContent(t.panel.language))}}},[s._v(" "+s._s(t.panel.t("johannschopplich.content-translator.translate",{language:t.panel.language.code.toUpperCase()}))+" ")])],2)],1):[e("k-box",{attrs:{theme:"none"}},[e("k-button-group",{attrs:{layout:"collapsed"}},[e("k-button",{directives:[{name:"show",rawName:"v-show",value:t.syncableFields.length,expression:"syncableFields.length"}],attrs:{disabled:t.panel.language.default,size:"sm",variant:"filled"},on:{click:function(d){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.sync",{language:t.defaultLanguage.name}),()=>t.syncModelContent())}}},[s._v(" "+s._s(t.panel.t("johannschopplich.content-translator.sync"))+" ")]),e("k-button",{attrs:{disabled:t.panel.language.default,icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(d){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.translate",{language:t.panel.language.name}),()=>t.translateModelContent(t.panel.language,t.defaultLanguage))}}},[s._v(" "+s._s(t.panel.t("johannschopplich.content-translator.translate",{language:t.panel.language.code.toUpperCase()}))+" ")])],1)],1),e("k-box",{directives:[{name:"show",rawName:"v-show",value:t.panel.language.default,expression:"panel.language.default"}],staticClass:"kct-mt-1",attrs:{theme:"none",text:t.panel.t("johannschopplich.content-translator.help.disallowDefaultLanguage")}})]:e("k-box",{attrs:{theme:"info"}},[e("k-text",[s._v(" You have to define at least one translatable field for the "),e("code",[s._v("translatableFields")]),s._v(" blueprint or in your Kirby configuration. ")])],1):e("k-box",{attrs:{theme:"info"}},[e("k-text",[s._v(" This section requires multi-language support to be enabled. ")])],1)],2):s._e()},q=[],H=K(X,Y,q,!1,null,null,null,null);const Q=H.exports;window.panel.plugin("johannschopplich/content-translator",{sections:{"content-translator":Q}})})();
