(function(){"use strict";const n=window.Vue;function R(){return window.panel}function O(){return R().api}function U(){const l=O();return{load:({parent:e,name:t})=>l.get(`${e}/sections/${t}`)}}function j(){var s;return((s=n.getCurrentInstance())==null?void 0:s.proxy).$store}const S=n.computed;n.customRef,n.defineAsyncComponent,n.defineComponent,n.effectScope,n.getCurrentInstance,n.getCurrentScope,n.h,n.inject,n.isProxy,n.isReactive,n.isReadonly,n.isRef,n.isShallow,n.markRaw,n.nextTick,n.onActivated,n.onBeforeMount;const B=n.onBeforeUnmount;n.onBeforeUpdate,n.onDeactivated,n.onErrorCaptured,n.onMounted,n.onRenderTracked,n.onRenderTriggered,n.onScopeDispose,n.onServerPrefetch,n.onUnmounted,n.onUpdated,n.provide,n.proxyRefs,n.reactive,n.readonly;const g=n.ref;n.shallowReactive,n.shallowReadonly,n.shallowRef,n.toRaw,n.toRef,n.toRefs,n.triggerRef,n.unref,n.useAttrs,n.useCssModule,n.useCssVars,n.useListeners,n.useSlots,n.watch,n.watchEffect,n.watchPostEffect,n.watchSyncEffect;const D={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},b="__content-translator__/translate",E=5;function N(){const l=O();return{recursiveTranslateContent:async(e,{sourceLanguage:t,targetLanguage:p,translatableStructureFields:d=[],translatableBlocks:y={}})=>{const v=[],c=i=>{for(const o of i)for(const a in o)d.includes(a)&&o[a]&&(typeof o[a]=="string"?v.push(async()=>{const u=await l.post(b,{sourceLanguage:t,targetLanguage:p,text:o[a]});o[a]=u.result.text}):Array.isArray(o[a])&&o[a].every(u=>typeof u=="string")&&v.push(async()=>{for(const u in o[a]){if(!o[a][u])continue;const _=await l.post(b,{sourceLanguage:t,targetLanguage:p,text:o[a][u]});o[a][u]=_.result.text}}))},h=i=>{for(const o of i)if(!(!C(o.content)||!o.id||o.isHidden===!0)&&Object.keys(y).includes(o.type)){for(const a of Object.keys(o.content))if(P(y[o.type]).includes(a)&&o.content[a]){if(Array.isArray(o.content[a])&&o.content[a].every(u=>C(u)&&u.content)){h(o.content[a]);continue}if(Array.isArray(o.content[a])&&o.content[a].every(u=>C(u)&&Object.keys(u).some(_=>d.includes(_)))){c(o.content[a]);continue}v.push(async()=>{const u=await l.post(b,{sourceLanguage:t,targetLanguage:p,text:o.content[a]});o.content[a]=u.result.text})}}};for(const i in e)if(e[i]){if(typeof e[i]=="string")v.push(async()=>{const o=await l.post(b,{sourceLanguage:t,targetLanguage:p,text:e[i]});e[i]=o.result.text});else if(Array.isArray(e[i])&&e[i].length>0){if(e[i].every(o=>typeof o=="string")){e[i]=await Promise.all(e[i].filter(Boolean).map(async o=>(await l.post(b,{sourceLanguage:t,targetLanguage:p,text:o})).result.text));continue}if(e[i].every(o=>C(o)&&o.columns)){for(const o of e[i])for(const a of o.columns)h(a.blocks);continue}if(e[i].every(o=>C(o)&&o.content)&&h(e[i]),e[i].every(o=>C(o)&&Object.keys(o).some(a=>d.includes(a)))){c(e[i]);continue}}}try{await I(v)}catch(i){throw console.error(i),i}return e}}}async function I(l,s=E){for(let e=0;e<l.length;e+=s){const t=l.slice(e,e+s);await Promise.all(t.map(p=>p()))}}function P(l){return Array.isArray(l)?l:[l]}function C(l){return typeof l=="object"&&l!==null}function z(l,s,e,t,p,d,y,v){var c=typeof l=="function"?l.options:l;s&&(c.render=s,c.staticRenderFns=e,c._compiled=!0),t&&(c.functional=!0),d&&(c._scopeId="data-v-"+d);var h;if(y?(h=function(a){a=a||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!a&&typeof __VUE_SSR_CONTEXT__<"u"&&(a=__VUE_SSR_CONTEXT__),p&&p.call(this,a),a&&a._registeredComponents&&a._registeredComponents.add(y)},c._ssrRegister=h):p&&(h=v?function(){p.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:p),h)if(c.functional){c._injectStyles=h;var i=c.render;c.render=function(u,_){return h.call(_),i(u,_)}}else{var o=c.beforeCreate;c.beforeCreate=o?[].concat(o,h):[h]}return{exports:l,options:c}}const T={...D},K=Object.assign({inheritAttrs:!1},{__name:"ContentTranslator",props:T,setup(l){const s=l,e=R(),t=j(),{recursiveTranslateContent:p}=N(),d=g(),y=g(!0),v=g([]),c=g([]),h=g([]),i=g([]),o=g(!1),a=g(),u=g({}),_=e.languages.find(f=>f.default),A=S(()=>t.getters["content/values"]()),M=S(()=>Object.fromEntries(Object.entries(A.value).filter(([f])=>c.value.includes(f))));(async()=>{const{load:f}=U(),r=await f({parent:s.parent,name:s.name});d.value=$(r.label)||e.t("johannschopplich.content-translator.label"),y.value=r.confirm??r.config.confirm??!0,c.value=r.translatableFields??r.config.translatableFields??[],h.value=r.translatableStructureFields??r.config.translatableStructureFields??[],v.value=r.syncableFields??r.config.syncableFields??[],i.value=r.translatableBlocks??r.config.translatableBlocks??[],o.value=r.title??r.config.title??!1,a.value=r.config??{},e.events.on("model.update",k),e.events.on("page.changeTitle",k),k()})(),B(()=>{e.events.off("model.update",k),e.events.off("page.changeTitle",k)});function $(f){return!f||typeof f=="string"?f:f[e.translation.code]??Object.values(f)[0]}async function q(f){let{title:r,content:x}=u.value;if(f){const m=await F(f);r=m.title,x=m.content}const w=Object.fromEntries(Object.entries(x).filter(([m])=>v.value.includes(m)));for(const[m,W]of Object.entries(w))t.dispatch("content/update",[m,W]);o.value&&(await e.api.patch(`${e.view.path}/title`,{title:r}),await e.view.reload()),e.notification.success(e.t("johannschopplich.content-translator.notification.synced"))}async function H(f,r){e.view.isLoading=!0;const x=JSON.parse(JSON.stringify(M.value));try{await p(x,{sourceLanguage:r==null?void 0:r.code,targetLanguage:f.code,translatableStructureFields:h.value,translatableBlocks:i.value})}catch(w){console.error(w),e.notification.error(e.t("error"));return}for(const[w,m]of Object.entries(x))t.dispatch("content/update",[w,m]);if(o.value){const{result:w}=await e.api.post(b,{sourceLanguage:r==null?void 0:r.code,targetLanguage:f.code,text:e.view.title});await e.api.patch(`${e.view.path}/title`,{title:w.text}),await e.view.reload()}else e.view.isLoading=!1;e.notification.success(e.t("johannschopplich.content-translator.notification.translated"))}async function k(){u.value=await F(_)}function F(f){return e.api.get(e.view.path,{language:f.code})}function Q(f,r){if(!y.value){r==null||r();return}e.dialog.open({component:"k-text-dialog",props:{text:f},on:{submit:()=>{e.dialog.close(),r==null||r()}}})}return{__sfc:!0,propsDefinition:T,props:s,panel:e,store:t,recursiveTranslateContent:p,label:d,confirm:y,syncableFields:v,translatableFields:c,translatableStructureFields:h,translatableBlocks:i,translateTitle:o,config:a,defaultLanguageData:u,defaultLanguage:_,currentContent:A,translatableContent:M,t:$,syncModelContent:q,translateModelContent:H,updateModelDefaultLanguageData:k,getModelData:F,openModal:Q}}});var V=function(){var p;var s=this,e=s._self._c,t=s._self._setupProxy;return t.config?e("k-section",{attrs:{label:t.label}},[t.panel.multilang?!t.config.translateFn&&!((p=t.config.DeepL)!=null&&p.apiKey)?e("k-box",{attrs:{theme:"empty"}},[e("k-text",[s._v(" You need to set the either a custom "),e("code",[s._v("translateFn")]),s._v(" or the "),e("code",[s._v("DeepL.apiKey")]),s._v(" option for the "),e("code",[s._v("johannschopplich.content-translator")]),s._v(" namespace in your Kirby configuration. ")])],1):t.translatableFields.length?t.config.allowDefaultLanguageOverwrite?e("k-box",{attrs:{theme:"none"}},[e("k-button-group",{attrs:{layout:"collapsed"}},[s._l(t.panel.languages.filter(d=>d.code!==t.panel.language.code),function(d){return e("k-button",{directives:[{name:"show",rawName:"v-show",value:t.syncableFields.length,expression:"syncableFields.length"}],key:d.code,attrs:{size:"sm",variant:"filled"},on:{click:function(y){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.syncFrom",{language:d.name}),()=>t.syncModelContent(d))}}},[s._v(" "+s._s(t.panel.t("johannschopplich.content-translator.importFrom",{language:d.code.toUpperCase()}))+" ")])}),e("k-button",{attrs:{icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(d){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.translate",{language:t.panel.language.name}),()=>t.translateModelContent(t.panel.language))}}},[s._v(" "+s._s(t.panel.t("johannschopplich.content-translator.translate",{language:t.panel.language.code.toUpperCase()}))+" ")])],2)],1):[e("k-box",{attrs:{theme:"none"}},[e("k-button-group",{attrs:{layout:"collapsed"}},[e("k-button",{directives:[{name:"show",rawName:"v-show",value:t.syncableFields.length,expression:"syncableFields.length"}],attrs:{disabled:t.panel.language.default,size:"sm",variant:"filled"},on:{click:function(d){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.sync",{language:t.defaultLanguage.name}),()=>t.syncModelContent())}}},[s._v(" "+s._s(t.panel.t("johannschopplich.content-translator.sync"))+" ")]),e("k-button",{attrs:{disabled:t.panel.language.default,icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(d){t.openModal(t.panel.t("johannschopplich.content-translator.dialog.translate",{language:t.panel.language.name}),()=>t.translateModelContent(t.panel.language,t.defaultLanguage))}}},[s._v(" "+s._s(t.panel.t("johannschopplich.content-translator.translate",{language:t.panel.language.code.toUpperCase()}))+" ")])],1)],1),e("k-box",{directives:[{name:"show",rawName:"v-show",value:t.panel.language.default,expression:"panel.language.default"}],staticClass:"kct-mt-1",attrs:{theme:"none",text:t.panel.t("johannschopplich.content-translator.help.disallowDefaultLanguage")}})]:e("k-box",{attrs:{theme:"info"}},[e("k-text",[s._v(" You have to define at least one translatable field for the "),e("code",[s._v("translatableFields")]),s._v(" blueprint or in your Kirby configuration. ")])],1):e("k-box",{attrs:{theme:"info"}},[e("k-text",[s._v(" This section requires multi-language support to be enabled. ")])],1)],2):s._e()},J=[],X=z(K,V,J,!1,null,null,null,null);const Y=X.exports;window.panel.plugin("johannschopplich/content-translator",{sections:{"content-translator":Y}})})();
