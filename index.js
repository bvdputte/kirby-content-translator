(function(){"use strict";const f={props:{blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},methods:{load(){return this.$api.get(`${this.parent}/sections/${this.name}`)}}};function p(t=""){return t.startsWith("/")}function g(t=""){return p(t)?t:"/"+t}const _={computed:{locales(){return this.$panel.languages.map(t=>t.code)}},methods:{getNonLocalizedPath(t){const n=new URL(t).pathname.split("/").filter(Boolean);return this.locales.includes(n[0])&&n.shift(),g(n.join("/"))}}},m=5,y={methods:{async recursiveTranslateContent(t,{sourceLanguage:e,targetLanguage:n,translatableBlocks:r={}}){const i=[];for(const s in t)if(t[s]){if(typeof t[s]=="string")i.push(async()=>{const a=await this.$api.post("__content-translator__/translate",{sourceLanguage:e,targetLanguage:n,text:t[s]});t[s]=a.result.text});else if(Array.isArray(t[s])){if(t[s].every(a=>typeof a=="string"))t[s]=await Promise.all(t[s].filter(Boolean).map(async a=>(await this.$api.post("__content-translator__/translate",{sourceLanguage:e,targetLanguage:n,text:a})).result.text));else for(const a of t[s])if(!(!$(a.content)||!a.id||a.isHidden===!0)&&Object.keys(r).includes(a.type))for(const c of Object.keys(a.content))v(r[a.type]).includes(c)&&a.content[c]&&i.push(async()=>{const o=await this.$api.post("__content-translator__/translate",{sourceLanguage:e,targetLanguage:n,text:a.content[c]});a.content[c]=o.result.text})}}try{await b(i)}catch(s){throw console.error(s),s}return t}}};async function b(t,e=m){for(let n=0;n<t.length;n+=e){const r=t.slice(n,n+e);await Promise.all(r.map(i=>i()))}}function v(t){return Array.isArray(t)?t:[t]}function $(t){return typeof t=="object"&&t!==null}function C(t,e,n,r,i,s,a,c){var o=typeof t=="function"?t.options:t;e&&(o.render=e,o.staticRenderFns=n,o._compiled=!0),r&&(o.functional=!0),s&&(o._scopeId="data-v-"+s);var h;if(a?(h=function(l){l=l||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!l&&typeof __VUE_SSR_CONTEXT__<"u"&&(l=__VUE_SSR_CONTEXT__),i&&i.call(this,l),l&&l._registeredComponents&&l._registeredComponents.add(a)},o._ssrRegister=h):i&&(h=c?function(){i.call(this,(o.functional?this.parent:this).$root.$options.shadowRoot)}:i),h)if(o.functional){o._injectStyles=h;var O=o.render;o.render=function(L,d){return h.call(d),O(L,d)}}else{var u=o.beforeCreate;o.beforeCreate=u?[].concat(u,h):[h]}return{exports:t,options:o}}const w={mixins:[f,_,y],data(){return{label:void 0,confirm:!0,syncableFields:[],translatableFields:[],translatableBlocks:[],config:void 0,defaultLanguage:this.$panel.languages.find(t=>t.default),defaultContent:{}}},computed:{currentContent(){return this.$store.getters["content/values"]()},syncableContent(){return Object.fromEntries(Object.entries(this.defaultContent).filter(([t])=>this.syncableFields.includes(t)))},translatableContent(){return Object.fromEntries(Object.entries(this.currentContent).filter(([t])=>this.translatableFields.includes(t)))}},async created(){const t=await this.load();this.label=this.t(t.label)||this.$t("johannschopplich.content-translator.label"),this.confirm=t.confirm??t.config.confirm??!0,this.translatableFields=t.translatableFields??t.config.translatableFields??[],this.syncableFields=t.syncableFields??t.config.syncableFields??[],this.translatableBlocks=t.translatableBlocks??t.config.translatableBlocks??[],this.config=t.config??{},this.$panel.events.on("model.update",this.updateModelDefaultContent),this.updateModelDefaultContent()},beforeDestroy(){this.$panel.events.off("model.update",this.updateModelDefaultContent)},methods:{t(t){return Array.isArray(t)?t[this.$panel.translation.code]??Object.values(t)[0]:t},syncModelContent(){for(const[t,e]of Object.entries(this.syncableContent))this.$store.dispatch("content/update",[t,e]);this.$panel.notification.success(this.$t("johannschopplich.content-translator.notification.synced"))},async translateModelContent(t){this.$panel.view.isLoading=!0;const e=JSON.parse(JSON.stringify(this.translatableContent));try{await this.recursiveTranslateContent(e,{sourceLanguage:this.defaultLanguage.code,targetLanguage:t.code,translatableBlocks:this.translatableBlocks})}catch(n){console.error(n),this.$panel.notification.error(this.$t("error"));return}for(const[n,r]of Object.entries(e))this.$store.dispatch("content/update",[n,r]);this.$panel.view.isLoading=!1,this.$panel.notification.success(this.$t("johannschopplich.content-translator.notification.translated"))},async updateModelDefaultContent(){const{content:t}=await this.$api.get(this.$panel.view.path,{language:this.defaultLanguage.code});this.defaultContent=t},openModal(t,e){if(!this.confirm){e==null||e();return}this.$panel.dialog.open({component:"k-text-dialog",props:{text:t},on:{submit:()=>{this.$panel.dialog.close(),e==null||e()}}})}}};var k=function(){var r,i,s;var e=this,n=e._self._c;return n("k-section",{directives:[{name:"show",rawName:"v-show",value:e.config,expression:"config"}],attrs:{label:e.label}},[e.$panel.multilang?!((r=e.config)!=null&&r.translateFn)&&!((s=(i=e.config)==null?void 0:i.DeepL)!=null&&s.apiKey)?n("k-box",{attrs:{theme:"none"}},[n("k-text",[e._v(" You need to set the either a custom "),n("code",[e._v("translateFn")]),e._v(" or the "),n("code",[e._v("DeepL.apiKey")]),e._v(" option for the "),n("code",[e._v("johannschopplich.content-translator")]),e._v(" namespace in your Kirby configuration. ")])],1):e._e():n("k-box",{attrs:{theme:"info"}},[n("k-text",[e._v(" This section requires multi-language support to be enabled. ")])],1),e.translatableFields.length?n("k-box",{attrs:{theme:"none"}},[n("k-button-group",{attrs:{layout:"collapsed"}},[n("k-button",{directives:[{name:"show",rawName:"v-show",value:e.syncableFields.length,expression:"syncableFields.length"}],attrs:{disabled:e.$panel.language.default,size:"sm",variant:"filled"},on:{click:function(a){e.openModal(e.$t("johannschopplich.content-translator.dialog.sync",{language:e.defaultLanguage.name}),()=>e.syncModelContent())}}},[e._v(" "+e._s(e.$t("johannschopplich.content-translator.sync"))+" ")]),e._l(e.$panel.languages.filter(a=>!a.default),function(a){return n("k-button",{key:a.code,attrs:{disabled:e.$panel.language.default,icon:"translate",size:"sm",variant:"filled",theme:"notice"},on:{click:function(c){e.openModal(e.$t("johannschopplich.content-translator.dialog.translate",{language:a.name}),()=>e.translateModelContent(a))}}},[e._v(" "+e._s(e.$t("johannschopplich.content-translator.translate",{language:a.code.toUpperCase()}))+" ")])})],2)],1):n("k-box",{attrs:{theme:"info"}},[n("k-text",[e._v(" You have to define at least one translatable field for the "),n("code",[e._v("translatableFields")]),e._v(" blueprint or in your Kirby configuration. ")])],1),n("k-box",{directives:[{name:"show",rawName:"v-show",value:e.$panel.language.default,expression:"$panel.language.default"}],staticClass:"kct-mt-1",attrs:{theme:"none",text:e.$t("johannschopplich.content-translator.help.disallowDefaultLanguage")}})],1)},F=[],x=C(w,k,F,!1,null,null,null,null);const M=x.exports;window.panel.plugin("johannschopplich/content-translator",{sections:{"content-translator":M}})})();
